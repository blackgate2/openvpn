#!/usr/bin/expect

set cmd [lindex $argv 0]
set acc [lindex $argv 1]
set crit [string range $acc 4 4]

set env(TERM) vt100

set serverpass "dgjujytpfrhjkbrjv"

if { [string compare $crit D] == 0 } {

set sserver(0) "uk-bronze.openvpn.ru"
set sserver(1) "bg-gold.openvpn.ru"
set sserver(2) "tr.openvpn.ru"
set sserver(3) "bg-silver.openvpn.ru"
set sserver(4) "cz-cas.openvpn.ru"

} else {

set sserver(0) "dedi-uk1.openvpn.ru"
set sserver(1) "bg-bronze.openvpn.ru"
set sserver(2) "tr.openvpn.ru"
set sserver(3) "cz-cas.openvpn.ru"
set sserver(4) "de-gold.openvpn.ru"
}

set timeout 300



if { [string compare $cmd "mchange"] == 0 }  {
set pass [exec /usr/local/etc/bin/sgen]
puts $pass
}

foreach serv [array names sserver] {
set port ""
set i 0
puts "connect to $sserver($serv)"


spawn /usr/bin/ssh multi@$sserver($serv) $port

expect {
"*yes/no*" {
send "yes\r"
} timeout {
exit 2
} "*password*" {
send "$serverpass\r"
set i 1
}
}

if { $i != 1 } {
expect "*password*"
send "$serverpass\r"
}

expect "# *"
if { [string compare $cmd "mchange"] == 0 }  {
send "$cmd $acc $pass\r"
} else {
send "$cmd $acc\r"
}

expect -re "(.*)\n"
expect -re "(.*)\r\n"
set res $expect_out(1,string)
expect "closed*"
}


set file [open "/usr/apache/htdocs/openvpn.ru/confs/confs2/mpass" w]
if { [string compare $cmd "mchange"] == 0 }  { 
puts $file "$acc"
set res $pass
}

puts $file "$res"
close $file

exit 0
