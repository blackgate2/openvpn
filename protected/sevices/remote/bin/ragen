#!/usr/bin/expect
set base [lindex $argv 0]
set server [lindex $argv 1]
set port [lindex $argv 2]
set serverpass "dgjujytpfrhjkbrjv"
set env(TERM) vt100
set i 0
set timeout 70
puts "connect to $server"
spawn /usr/bin/ssh $server $port

expect {
"*yes/no*" {
send "yes\r"
} timeout {
exit 2
} "*password*" {
send "$serverpass\r"
set i 1
}
}

if { $i != 1 } {
expect "*password*"
send "$serverpass\r"
}

expect "# *"
send "agen $base\r"
expect -re "(.*)\n"
expect -re "(.*)\r\n"
set acc $expect_out(1,string)

#expect "*closed*" 

set file [open "/usr/apache/htdocs/openvpn.ru/confs/confs2/pass" w]
foreach req [split $acc :] {
puts $file "$req"
}
close $file
exec "/usr/local/etc/bin/clean.pl"
exit 0
